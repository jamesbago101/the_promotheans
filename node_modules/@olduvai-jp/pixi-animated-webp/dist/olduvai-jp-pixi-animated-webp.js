/*!
 * @olduvai-jp/pixi-animated-webp - v1.0.4
 * Compiled Thu, 03 Jul 2025 05:53:24 UTC
 *
 * @olduvai-jp/pixi-animated-webp is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 * 
 * Copyright 2025, dyamagishi <dyamagishi@olduvai.jp>, All Rights Reserved
 */this.PIXI=this.PIXI||{},this.PIXI.pixiAnimatedWebp=function(m,i){"use strict";var I=Object.defineProperty,l=Object.getOwnPropertySymbols,f=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable,w=(t,a,e)=>a in t?I(t,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[a]=e,F=(t,a)=>{for(var e in a||(a={}))f.call(a,e)&&w(t,e,a[e]);if(l)for(var e of l(a))y.call(a,e)&&w(t,e,a[e]);return t},b=(t,a)=>{var e={};for(var r in t)f.call(t,r)&&a.indexOf(r)<0&&(e[r]=t[r]);if(t!=null&&l)for(var r of l(t))a.indexOf(r)<0&&y.call(t,r)&&(e[r]=t[r]);return e};const d=class extends i.Sprite{constructor(t,a){super(i.Texture.EMPTY),this.animationSpeed=1,this.loop=!0,this.duration=0,this.autoPlay=!0,this.dirty=!1,this._currentFrame=0,this._autoUpdate=!1,this._isConnectedToTicker=!1,this._playing=!1,this._currentTime=0,this.onRender=()=>this.updateFrame();const e=Object.assign({},d.defaultOptions,a),{scaleMode:r,width:h,height:n}=e,s=b(e,["scaleMode","width","height"]),c=i.DOMAdapter.get().createCanvas(h,n),u=c.getContext("2d",{willReadFrequently:!0});this.texture=i.Texture.from(c),this.texture.source.scaleMode=r,this.duration=t[t.length-1].end,this._frames=t,this._context=u,this._playing=!1,this._currentTime=0,this._isConnectedToTicker=!1,Object.assign(this,s),this.currentFrame=0,s.autoPlay&&this.play()}static async fromBuffer(t,a){if(!t||t.byteLength===0)throw new Error("Invalid buffer");if(typeof ImageDecoder=="undefined")throw console.error("ImageDecoder API is not supported in this environment"),new Error("ImageDecoder API is not supported in this environment");const e=new ImageDecoder({data:t,type:"image/webp"});if(await e.tracks.ready,e.tracks.length===0)throw new Error("No tracks found in WebP");const r=e.tracks.selectedTrack;if(!r)throw new Error("No selected track found in WebP");const h=r.frameCount,n=[],s=i.DOMAdapter.get().createCanvas(),c=s.getContext("2d",{willReadFrequently:!0});let u=0;for(let g=0;g<h;g++){const{image:o,complete:P}=await e.decode({frameIndex:g});if(!o||!P)continue;const T=o.duration/1e3;s.width=o.displayWidth,s.height=o.displayHeight,c.drawImage(o,0,0);const k=c.getImageData(0,0,o.displayWidth,o.displayHeight);n.push({imageData:k,start:u,end:u+T}),u+=T,o.close()}if(e.close(),n.length===0)throw new Error("No frames decoded from WebP");const{width:C,height:v}=n[0].imageData;return new d(n,F({width:C,height:v},a))}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(i.Ticker.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(i.Ticker.shared.add(this.update,this,i.UPDATE_PRIORITY.HIGH),this._isConnectedToTicker=!0),!this.loop&&this.currentFrame===this._frames.length-1&&(this._currentTime=0))}get progress(){return this._currentTime/this.duration}get playing(){return this._playing}update(t){var a,e;if(!this._playing)return;const r=this.animationSpeed*t.elapsedMS;this._currentTime+=r;const h=this._currentTime%this.duration,n=this._frames.findIndex(s=>h>=s.start&&h<s.end);n!==-1&&(this._currentTime>=this.duration?this.loop?(this._currentTime=h,this.updateFrameIndex(n),(a=this.onLoop)==null||a.call(this)):(this._currentTime=this.duration,this.updateFrameIndex(this.totalFrames-1),(e=this.onComplete)==null||e.call(this),this.stop()):this.updateFrameIndex(n))}updateFrame(){if(!this.dirty)return;const{imageData:t}=this._frames[this._currentFrame];this._context.putImageData(t,0,0),this._context.fillStyle="transparent",this._context.fillRect(0,0,0,1),this.texture.source.update(),this.dirty=!1}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(i.Ticker.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(i.Ticker.shared.add(this.update,this),this._isConnectedToTicker=!0))}get currentFrame(){return this._currentFrame}set currentFrame(t){this.updateFrameIndex(t),this._currentTime=this._frames[t].start}updateFrameIndex(t){var a;if(t<0||t>=this._frames.length)throw new Error(`Frame index out of range, expecting 0 to ${this.totalFrames}, got ${t}`);this._currentFrame!==t&&(this._currentFrame=t,this.dirty=!0,(a=this.onFrameChange)==null||a.call(this,t))}get totalFrames(){return this._frames.length}destroy(){this.stop(),super.destroy(!0);const t=null;this._context=t,this._frames=t,this.onComplete=t,this.onFrameChange=t,this.onLoop=t}static fromFrames(t,a=!0){if(!t||t.length===0)throw new Error("No frames provided");const{width:e,height:r}=t[0].imageData;return new d(t,{width:e,height:r,autoUpdate:a})}static fromImageData(t,a=1e3){const e={imageData:t,start:0,end:a};return new d([e],{width:t.width,height:t.height})}clone(){return new d(this._frames,{width:this.texture.width,height:this.texture.height,scaleMode:this.texture.source.scaleMode,animationSpeed:this.animationSpeed,loop:this.loop,autoPlay:!1,autoUpdate:this._autoUpdate,onComplete:this.onComplete,onFrameChange:this.onFrameChange,onLoop:this.onLoop})}};let p=d;p.defaultOptions={scaleMode:"linear",fps:30,loop:!0,animationSpeed:1,autoPlay:!0,autoUpdate:!0,onComplete:null,onFrameChange:null,onLoop:null};const _={extension:i.ExtensionType.Asset,detection:{test:async()=>!0,add:async t=>[...t,"webp"],remove:async t=>t.filter(a=>a!=="webp")},loader:{name:"animatedWebpLoader",extension:{type:i.ExtensionType.LoadParser,priority:10},test:t=>i.path.extname(t)===".webp",load:async(t,a)=>{try{const e=await(await i.DOMAdapter.get().fetch(t)).arrayBuffer();return await p.fromBuffer(e,a==null?void 0:a.data)}catch(e){throw console.error("Error in AnimatedWebPAsset loader:",e),e}},unload:async t=>{t.destroy()}}};return i.extensions.add(_),m.AnimatedWebP=p,m.AnimatedWebPAsset=_,m}({},PIXI);
//# sourceMappingURL=olduvai-jp-pixi-animated-webp.js.map
